# 排查CPU高负载问题

负载高，即就绪队列中的进程多，根本原因就是计算资源不够用导致排队。
而计算资源，无非就是CPU、内存、磁盘、网络。
下一步要做的，就是去查看进程中，有没有使用这些资源特别厉害的，把相关进程定位出来，然后到进程内部去查具体的问题。

CPU和内存用top或者ps可以看。值得一提的是`top -H`打开top界面，可以让top的统计维度细化到线程而非进程。
对于java程序，还可用`jstack`命令以及相关的进程号，查询到性能出现问题的代码具体在哪一行。

磁盘IO用iostat等命令。

网络则用ifstat，iftop等命令。

# 分布式部署问题

> Shopee面试提到的

一个应用，如果想要做两台机器的分布，需要注意哪些点？
需要注意的东西有很多，回答的角度可以是

- 前端的负载均衡、会话管理
- 中端的状态同步、配置同步
- 后端的数据同步

前端负载均衡的实现可以依靠的方案包括Nginx（七层负载均衡）。一般一个七层负载均衡的Nginx后端带几十个worker就撑不住了，此时考虑使用LVS等其他更低层级的负载均衡器放在前面。
会话管理是指同一个来源的请求总是发送到同一个worker上，其实也是负载均衡的一个策略方面的东西。通常可以使用一个共同的缓存来实现这个事。

中端的状态、配置同步等通常使用一些第三方的同步性保持解决方案，如zookeeper等。

后端数据同步则需要数据库集群之间的同步，主从复制等。

# 跨机房数据复制

> 陌陌提到的，具体问题是，A和B两个保有500台服务器的机房通过一条专线相连。先在想把A机房某机器上一个300G的文件给传输到B机房的所有机器上，该怎么做。

首先，通过专线进行数据转移是必不可少的。如果只有一条专线那么毫无选择，如果有多条专线可以考虑分片并发复制。

问题的关键点在于到达另一个机房后如何进行文件的分发。直接让所有机器去节点机器上取数据会把节点机器搞崩。一个可行的方案是采用数据库主从复制的套路，即有了replica之后replica本身也作为一个数据源进行数据分发。这样就可以在对数级的时间内完成数据的分发。

# 网页白屏可能原因是什么

> TX提到的

可以从客户端、服务端、网络三个角度来考虑这个问题。

## 客户端原因

- 浏览器兼容性

  这个就是个泛泛的理由，比如有些页面在Chrome，Firefox上好好的，但是用IE打开就是白屏。具体原理可能也是和解析出错有关。

- 头部内容解析出错

  ==由于HTML是从上至下依次解析的，如果在解析头部内容时就出错，那么整个页面自然就会白屏了。==

  比较常见容易出错的内容是JavaScript。这也是为什么要尽量避免把JavaScript写到头部中。

  另外比如通常用`<meta>`标签对页面的编码进行声明，在那之前默认编码是ascii。如果在meta之前的HTML代码中有非ascii字符，也会导致白屏。

  对于解析出错的时候，可以查看客户端console提示的相关错误信息。

- 硬件资源不足，解析线程崩溃

  对于一些比较重的网页，如果硬件资源不足以支撑浏览器解析，则可能解析线程崩溃，导致白屏。

## 服务端原因

- 反向代理服务器异常

  通常在worker服务器前会有反向代理服务器。有可能反向代理服务器发生异常没有办法沟通到worker服务器，而直接返回一个白屏。当然通常的反向代理服务器如Nginx都会有相关错误页面，也不至于白屏。

- web程序内部出现问题

  这就没什么好说的了，内部出现问题或者bug返回一个空页面。

## 网络原因

- 链接超时：

  如果请求的资源过大，或者因为其他网络原因无法请求到相关静态资源，则也可能导致白屏。

- CDN异常：

  某些页面上调用了CDN的资源，而如果CDN资源异常，则导致问题。

上述两原因，归根结底还是资源解析的问题。

==事实上，碰到白屏，绝大多数可能还是资源解析的问题，只要牢记HTML从上之下解析，若在解析的靠前阶段就GG了，就会白屏。至于GG的原因，是多样性的，可能是语法问题、资源加载顺序问题、没有获取到静态文件（CDN问题，网络不好等）。==

# 访问量上升后性能优化思路

主要朝着这么几个思路去想

- 首先，访问量上去了，第一个必然能想到要进行扩容。既然要扩容就涉及到
  - 前端访问 负载均衡、会话管理
  - 中端应用 配置同步、状态同步
  - 后端数据库 数据同步
- 增加缓存，利用Redis等缓存系统，进行热点数据缓存加快响应。
- 处理时间较长的任务以消息队列等异步方式执行，提升系统性能上限。
- 使用CDN，静态文件压缩技术等，加快静态文件的访问速度。