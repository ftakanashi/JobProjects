# 缓存三大问题
缓存系统的三大问题是指缓存穿透、击穿、雪崩。
这里说的缓存，特指狭义上，放在Web应用层之后，数据库层之前的缓存系统。一般来说，将热点查询数据放在缓存中，可以快速响应请求，减轻数据库压力的作用。

一般的缓存处理的流程如下图：

![img](https://img-blog.csdn.net/20180919143214712?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2tvbmd0aWFvNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

## 缓存穿透
==缓存穿透是指用户请求中，请求的数据并不存在于缓存或数据库中，系统返回空结果的现象。==
此时，由于系统会绕过缓存去进行库查询，称为穿透。

缓存穿透现象本身是一个中性的词，但是有攻击者会故意编造一些明显不存在的数据请求比如`id=-1`之类的，并发起大量类似请求，迫使系统不断查询数据库，导致数据库压力上涨。
由于缓存系统本身的作用就是减轻数据库压力，所以这种行为可以视为是针对缓存机制的一种攻击。

###  解决方案概览

- 在应用层进行一些最基本的请求过滤。如对于上述`id=-1`这种异常ID值，直接在引用层拒绝掉就可以了。
- 第一次到数据库中查询发现空数据后，在缓存中写入`key-null`对相关信息。这样之后相同的请求在缓存层面就可直接返回空结果，避免了刷库。

## 缓存击穿

==缓存击穿指某个热点数据的缓存在某一时刻突然失效，而此时又有大量请求在并发访问这个数据。由于缓存中没了，所以在一瞬间有大量请求直接击穿至数据库，导致数据库压力陡增的现象。==

### 解决方案概览

- 一个显然的方案就是，将热点数据有效期设置为永久有效。
- 只有大量不互斥的并发才会导致击穿，所以可以加互斥锁控制并发。换言之，当热点数据缓存过期，大量请求到了之后，只有获取互斥锁的线程才能去取数。第一个线程取完数之后直接将数据加入缓存，之后的数据取数就可以直接读缓存，避免了击穿。

## 缓存雪崩

==缓存雪崩指缓存中的数据大批量地到期，一瞬间所有访问那些失效数据的请求都要查询数据库，导致库压力陡增的现象==

与缓存击穿比较，缓存击穿指某个热点数据的失效；雪崩则更加形象，指多个数据的失效。

### 解决方案概览

- 和缓存击穿类似，可以将部分热点数据设置为永不失效，这样也就不会有雪崩了。
- 避免缓存有效期的周期同步，即让不同的数据失效时间尽量均匀分布。