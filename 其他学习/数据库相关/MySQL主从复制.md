# 集群

在MySQL分布式集群中常常被问到以下几个领域的概念。主从复制、读写分离、分库分表等。

## 主从复制

主从复制是指分布式的情况下，为了保证主从服务器的数据一致性，当向主服务器插入数据后，从服务器将自动从主服务器上同步数据过来。

MySQL主从复制涉及主从服务器上共三个实体：binlog线程、IO线程、SQL线程。
整体流程是这样的：

1. 主服务器上数据发生改变，其binlog线程将相关改变写入binlog中
2. 从服务器的IO线程连接主服务器并且将binlog的变动读取出来，写入本地的中继日志（relay log）中
3. 从服务器的SQL线程读取中继日志，解析出主服务器上做的改动，并且将其Update到本服务器的分库中。
4. 第3步操作导致从服务器的binlog也发生相同变化，因此另一台从服务器此时不仅可以去同步主服务器，也可以来同步这台从服务器。

上述流程的著名图示如下：

![在这里插入图片描述](https://uploadfiles.nowcoder.com/files/20210411/115285789_1618134217150/20210121201012972.jpg)

主从复制的作用是

- 高可用和故障转移
- 负载均衡
- 数据备份
- 升级测试

### 主从复制延时问题

主从复制经常会发生延时问题。延时问题是指从服务器总是花费过长时间才能向主服务器同步到数据。

引起这个问题的原因可能是多方面的。比如最显而易见的，是主从服务器毕竟是两台服务器，需要通过网络连接，网络出问题了那么主从复制肯定出问题。除此之外，还可以考虑机器性能的问题。

比如主从服务器配置差距过大，那么从服务器肯定就跟不上主服务器的节奏导致延时；

比如从服务器通常是读服务器，如果有大量读请求需要处理，也会导致从服务器来不及进行数据同步；

比如大事务执行，在主服务器上事务本身就执行了较长时间，而binlog的写入必须等事务结束，所以从服务器上要干等待这段时间导致延迟；

除了上述原因外，还可以分析图中的流程。主服务器binlog thread写binlog，从服务器io thread读到binlog，从服务器io thread写relay log，从服务器sql thread读relay log，这四个流程，都是对日志的读写。而对日志的读写，从原理上来说就是顺序读写，因此并不太耗时。

真正耗时的地方，在于从服务器的sql thread写入数据库的操作。根据具体SQL语句不同，写的效率也有所差别，但是无论是怎么样的语句，对数据库的写肯定涉及到寻址操作，因此一定是随机写。这么一来，这也就成了整个流程唯一可能拖后腿的地方。在稍微老一点的MySQL中，sql thread只有一个，若主服务器更新数据TPS非常高，则可能会导致从服务器上单个线程反应不及时，导致延迟。

在MySQL5.7及以后版本中，允许sql thread的多线程。但是由于线程之间的执行顺序是随机的，有可能无法按照主库中的顺序挨个执行数据变更，导致数据不一致。所以在sql thread和relay log之间，MySQL额外设置了一个coordinator，由其维护一系列规则，基于规则进行数据的同步，保证数据一致性。

## 读写分离是什么

读写分离依赖于主从复制的分布式机制。

主服务器负责写，从服务器负责读，从而降低了锁的竞争。
从服务器因为不用写，所以引擎可以使用诸如无事务机制的MyISAM等。这类引擎的开销更小，帮助提升查询性能。
另外主从复制架构本来就加强了系统整体可用性。